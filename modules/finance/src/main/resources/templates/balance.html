<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Zarządzanie Majątkiem</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" th:attr="nonce=${cspNonce}"></script>
    <style layout:fragment="styles" th:attr="nonce=${cspNonce}">
        .balance-wealth-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 32px;
            padding: 48px;
            width: 100%;
            max-width: 1500px;
            margin: 0 auto;
            box-sizing: border-box;
            align-items: start;
        }

        .balance-summary-panel {
            background-color: #ffffff;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(35, 77, 32, 0.1);
            border: 2px solid var(--card-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 450px;
        }

        .balance-summary-panel h2 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-dark-green);
            margin: 0;
        }

        .balance-total-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--color-dark-green);
            margin: 12px 0 24px 0;
        }

        .balance-chart-container {
            position: relative;
            width: 100%;
            max-width: 280px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            margin: auto 0;
        }

        .balance-summary-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px 24px;
            width: 100%;
            margin-top: auto;
        }
        .balance-legend-item { display: flex; align-items: baseline; gap: 8px; }
        .balance-legend-percentage { font-size: 1.1rem; font-weight: 700; color: var(--color-hunter); }
        .balance-legend-label { font-size: 0.875rem; color: var(--color-moss); }

        .balance-assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 32px;
        }

        .balance-asset-card {
            background-color: #ffffff;
            border-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 16px;
            box-shadow: 0 10px 30px rgba(35, 77, 32, 0.1);
            border: 2px solid var(--card-border);
            min-height: 200px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .balance-asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(35, 77, 32, 0.15);
        }
        .balance-asset-details { display: flex; flex-direction: column; gap: 4px; }
        .balance-asset-name { font-size: 1rem; font-weight: 500; color: var(--color-hunter); }
        .balance-asset-value { font-size: 1.75rem; font-weight: 800; color: var(--color-dark-green); }

        .balance-asset-actions { display: flex; gap: 10px; margin-top: auto; }
        .balance-asset-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 50px;
            border: 2px solid;
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .balance-asset-button svg { width: 16px; height: 16px; }

        .balance-asset-button--confirm {
            background-color: var(--color-moss); color: var(--bg-warm-base); border-color: var(--color-moss);
            flex-grow: 1;
        }
        .balance-asset-button--confirm:hover { background-color: var(--bg-warm-base); color: var(--color-moss); }

        .balance-asset-button--edit { background-color: var(--bg-warm-base); color: var(--color-hunter); border-color: var(--bg-warm-base); }
        .balance-asset-button--edit:hover { background-color: var(--color-hunter); color: var(--bg-warm-base); border-color: var(--color-hunter); }

        .balance-asset-button--delete { background-color: var(--bg-decor-2); color: #fff; border-color: var(--bg-decor-2); }
        .balance-asset-button--delete:hover { background-color: #fff; color: var(--bg-decor-2); }

        .balance-asset-button--cancel { background-color: #e8e8e8; color: #555; border-color: #e8e8e8; }
        .balance-asset-button--cancel:hover { background-color: #555; color: #e8e8e8; border-color: #555; }


        .balance-asset-card--add {
            background-color: transparent;
            border: 2px dashed var(--color-sage);
            align-items: center;
            justify-content: center;
            cursor: default;
            box-shadow: none;
        }
        .balance-asset-card--add:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--color-moss);
            background-color: rgba(255, 255, 255, 0.4);
        }
        .balance-asset-card--add .balance-asset-button--confirm { font-size: 0.9rem; }

        .balance-form-inputs { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .balance-form-input {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid var(--color-sage);
            border-radius: 12px;
            background-color: #fdfdfb;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            color: var(--color-dark-green);
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        .balance-form-input:focus {
            outline: none;
            border-color: var(--color-moss);
            box-shadow: 0 0 0 4px rgba(56, 102, 65, 0.15);
        }
        .balance-form-contents { display: contents; }
        .balance-asset-edit { display: none; }

        @media (max-width: 1200px) {
            .balance-wealth-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .balance-wealth-container { padding: 24px; }
            .balance-assets-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="balance-wealth-container">
        <div class="balance-summary-panel">
            <h2>Struktura Majątku</h2>
            <p id="balanceTotalValue" class="balance-total-value">0,00 PLN</p>
            <div class="balance-chart-container">
                <canvas id="balanceWealthChart"></canvas>
            </div>
            <div id="balanceSummaryLegend" class="balance-summary-legend"></div>
        </div>

        <div class="balance-assets-grid">

            <div th:each="asset : ${assetsList}" class="balance-asset-card">
                <form th:action="@{/oskarinio143/moneyisland/finance/user/balance/modify}" method="post" class="balance-form-contents">
                    <input type="hidden" name="assetId" th:value="${asset.id}" />
                    <input type="hidden" name="username" th:value="${currentUsername}" />

                    <div class="balance-asset-view">
                        <div class="balance-asset-details">
                            <span class="balance-asset-name" th:text="${asset.assetName}">Nazwa aktywa</span>
                            <span class="balance-asset-value" th:text="${asset.assetValue} + ' PLN'">0.00 PLN</span>
                        </div>
                        <div class="balance-asset-actions">
                            <button type="button" class="balance-asset-button balance-asset-button--edit">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                <span>Edytuj</span>
                            </button>
                            <button type="submit" th:formaction="@{/oskarinio143/moneyisland/finance/user/balance/delete}" class="balance-asset-button balance-asset-button--delete">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                <span>Usuń</span>
                            </button>
                        </div>
                    </div>

                    <div class="balance-asset-edit">
                        <div class="balance-form-inputs">
                            <span class="balance-asset-name" th:text="${asset.assetName}">Nazwa aktywa</span>
                            <input type="number" name="assetValue" class="balance-form-input" placeholder="Wartość (PLN)" required step="0.01" th:value="${asset.assetValue}">
                        </div>
                        <div class="balance-asset-actions">
                            <button type="button" class="balance-asset-button balance-asset-button--cancel">Anuluj</button>
                            <button type="submit" class="balance-asset-button balance-asset-button--confirm">Zatwierdź</button>
                        </div>
                    </div>
                </form>
            </div>

            <form th:action="@{/oskarinio143/moneyisland/finance/user/balance/add}" method="post" class="balance-asset-card balance-asset-card--add">
                <div class="balance-form-inputs">
                    <input type="text" name="assetName" class="balance-form-input" placeholder="Nazwa składnika majątku" required>
                    <input type="number" name="assetValue" class="balance-form-input" placeholder="Wartość (PLN)" required step="0.01">
                    <input type="hidden" name="username" th:value="${currentUsername}" />
                </div>
                <button type="submit" class="balance-asset-button balance-asset-button--confirm">
                    Dodaj Nowy
                </button>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:attr="nonce=${cspNonce}">
        document.addEventListener('DOMContentLoaded', function () {
            const COLOR_PALETTE = ['#fde047', '#4ade80', '#60a5fa', '#c084fc', '#f87171', '#fb923c'];
            const assets = [];

            document.querySelectorAll('.balance-asset-card:not(.balance-asset-card--add)').forEach(card => {
                const name = card.querySelector('.balance-asset-name')?.textContent || 'Brak nazwy';
                const valueString = card.querySelector('.balance-asset-value')?.textContent || '0';
                const value = parseFloat(valueString.replace(/\s|PLN/g, '').replace(',', '.'));
                if (!isNaN(value)) {
                    assets.push({ label: name, value: value });
                }
            });

            const totalValue = assets.reduce((sum, asset) => sum + asset.value, 0);

            const totalValueElement = document.getElementById('balanceTotalValue');
            if (totalValueElement) {
                totalValueElement.textContent = totalValue.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN' });
            }

            const assetsWithPercentage = assets.map(asset => ({...asset, percentage: totalValue > 0 ? (asset.value / totalValue) * 100 : 0 }));

            const legendContainer = document.getElementById('balanceSummaryLegend');
            if(legendContainer) {
                legendContainer.innerHTML = '';
                assetsWithPercentage.forEach(asset => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'balance-legend-item';
                    legendItem.innerHTML = `<span class="balance-legend-percentage">${asset.percentage.toFixed(0)}%</span><span class="balance-legend-label">${asset.label}</span>`;
                    legendContainer.appendChild(legendItem);
                });
            }

            const chartLabels = assets.map(a => a.label);
            const chartValues = assets.map(a => a.value);
            const chartColors = COLOR_PALETTE.slice(0, assets.length);
            const maxValue = Math.max(...chartValues);
            const proportionalOffsets = chartValues.map(value => maxValue > 0 ? (value / maxValue) * 30 : 0);
            const ctx = document.getElementById('balanceWealthChart');

            if (ctx && assets.length > 0) {
                new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: chartColors, borderColor: '#fdfdfb', borderWidth: 6, borderRadius: 6, offset: proportionalOffsets }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { enabled: true } } }
                });
            }

            document.querySelectorAll('.balance-asset-button--edit').forEach(button => {
                button.addEventListener('click', function() {
                    const card = this.closest('.balance-asset-card');
                    const viewMode = card.querySelector('.balance-asset-view');
                    const editMode = card.querySelector('.balance-asset-edit');
                    const valueSpan = viewMode.querySelector('.balance-asset-value');
                    const valueInput = editMode.querySelector('input[name="assetValue"]');

                    const numericValue = parseFloat(valueSpan.textContent.replace(/\s|PLN/g, '').replace(',', '.'));
                    if (!isNaN(numericValue)) {
                        valueInput.value = numericValue.toFixed(2);
                    }

                    viewMode.style.display = 'none';
                    editMode.style.display = 'flex';
                    editMode.style.flexDirection = 'column';
                    editMode.style.gap = '16px';
                });
            });

            document.querySelectorAll('.balance-asset-button--cancel').forEach(button => {
                button.addEventListener('click', function() {
                    const card = this.closest('.balance-asset-card');
                    const viewMode = card.querySelector('.balance-asset-view');
                    const editMode = card.querySelector('.balance-asset-edit');

                    editMode.style.display = 'none';
                    viewMode.style.display = 'block';
                });
            });
        });
    </script>
</th:block>

</body>
</html>